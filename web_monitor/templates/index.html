<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≤–µ–±-—Å–∞–π—Ç—ñ–≤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä—É */
        .startup-progress {
            display: none;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            position: relative;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #2196f3;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            font-weight: bold;
            color: #1976d2;
        }
        
        .progress-numbers {
            color: #666;
            font-size: 0.9em;
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ä—Ç–æ–∫ */
        .monitor-item.updating {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }
        
        .monitor-item.updated {
            background-color: #d4edda !important;
            border-left: 4px solid #28a745;
            animation: updatedPulse 1s ease-out;
        }
        
        @keyframes updatedPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* –ñ–∏–≤—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è */
        .live-update {
            color: #28a745;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ü—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä –¥–ª—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ -->
        <div id="startupProgressContainer" class="startup-progress">
            <div id="startupProgressText" class="progress-text">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div class="progress-bar">
                <div id="startupProgressBar" class="progress-fill"></div>
            </div>
            <div id="startupProgressNumbers" class="progress-numbers"></div>
        </div>

        <!-- –ë–∞–Ω–µ—Ä —Å—Ç–∞—Ç—É—Å—É —Å–Ω—É -->
        <div id="sleepStatusBanner" class="sleep-status-banner" style="display: none;">
            <div class="sleep-status-content">
                <span class="sleep-icon">üò¥</span>
                <span class="sleep-text">–ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –≤ —Ä–µ–∂–∏–º—ñ —Å–Ω—É. –í—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ.</span>
            </div>
        </div>

        <header class="main-header">
            <h1>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≤–µ–±-—Å–∞–π—Ç—ñ–≤</h1>
            <div class="header-actions">
                <button id="sleepToggleBtn" class="btn btn-sleep">üí§ –†–µ–∂–∏–º —Å–Ω—É</button>
                <a href="/add" class="btn btn-primary">+ –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É</a>
                <button id="refreshBtn" class="btn btn-secondary">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
                <button id="forceCheckAllBtn" class="btn btn-action">‚ö° –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ</button>
            </div>
        </header>

        <main>
            <div id="messageContainer"></div>

            <section class="checks-section">
                <h2>–ê–∫—Ç–∏–≤–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ 
                    <span id="liveUpdateIndicator" class="live-update" style="display: none;">‚óè LIVE</span>
                </h2>
                <ul id="checksList" class="monitor-list">
                    <li class="loading-message">
                        <div class="loading-content">
                            <h3>üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫...</h3>
                            <p>–ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞</p>
                        </div>
                    </li>
                </ul>
            </section>
        </main>
    </div>

    <script>
        let appSleeping = false;
        let startupCheckInterval = null;
        let liveUpdateInterval = null;
        let isInitialLoad = true;

        // –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∂–∏–≤–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω—å
        function showLiveIndicator() {
            const indicator = document.getElementById('liveUpdateIndicator');
            if (indicator) {
                indicator.style.display = 'inline';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 3000);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = text;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ –∑ –∂–∏–≤–∏–º–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º–∏
        async function loadChecks() {
            console.log('üîÑ Loading checks...');
            
            try {
                const response = await fetch('/api/checks', {
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const checks = await response.json();
                console.log('üìä Loaded checks:', checks.length);
                
                displayChecks(checks);
                
                if (!isInitialLoad) {
                    showLiveIndicator();
                }
                
            } catch (error) {
                console.error('‚ùå Error loading checks:', error);
                if (isInitialLoad) {
                    showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫: ' + error.message, 'error');
                }
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
        function displayChecks(checks) {
            const checksList = document.getElementById('checksList');
            
            if (!checks || checks.length === 0) {
                checksList.innerHTML = `
                    <li class="no-checks">
                        <div class="no-checks-message">
                            <h3>–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫</h3>
                            <p>–î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É, –Ω–∞—Ç–∏—Å–Ω—É–≤—à–∏ –∫–Ω–æ–ø–∫—É "+ –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É"</p>
                        </div>
                    </li>
                `;
                return;
            }

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ—Å–Ω—É—é—á—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó
            const existingItems = {};
            Array.from(checksList.children).forEach(li => {
                const link = li.querySelector('a');
                if (link) {
                    const href = link.getAttribute('href');
                    const checkId = href ? href.split('/').pop() : null;
                    if (checkId) existingItems[checkId] = li;
                }
            });

            checksList.innerHTML = '';

            checks.forEach((check, index) => {
                const checkItem = createCheckItem(check);
                checksList.appendChild(checkItem);

                // –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –Ω–æ–≤–∏—Ö/–æ–Ω–æ–≤–ª–µ–Ω–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
                if (!isInitialLoad) {
                    if (existingItems[check.id]) {
                        // –ê–Ω—ñ–º–∞—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
                        checkItem.classList.add('updated');
                        setTimeout(() => {
                            checkItem.classList.remove('updated');
                        }, 1000);
                    } else {
                        // –ê–Ω—ñ–º–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞
                        checkItem.style.opacity = '0';
                        checkItem.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            checkItem.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                            checkItem.style.opacity = '1';
                            checkItem.style.transform = 'translateY(0)';
                        }, index * 100);
                    }
                }
            });

            console.log(`‚úÖ Displayed ${checks.length} checks`);
        }

        // –§—É–Ω–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
        function createCheckItem(check) {
            const li = document.createElement('li');
            
            let statusClass = 'status-pending';
            let statusText = '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è';
            
            switch(check.last_result) {
                case 'changed':
                    statusClass = 'status-changed';
                    statusText = '–ó–º—ñ–Ω–∏ –≤–∏—è–≤–ª–µ–Ω–æ';
                    break;
                case 'no_change':
                    statusClass = 'status-unchanged';
                    statusText = '–ë–µ–∑ –∑–º—ñ–Ω';
                    break;
                case 'error':
                    statusClass = 'status-error';
                    statusText = '–ü–æ–º–∏–ª–∫–∞';
                    break;
            }
            
            const lastChecked = check.last_checked_at ? 
                new Date(check.last_checked_at).toLocaleString('uk-UA') : 
                '–ù—ñ–∫–æ–ª–∏';
            
            const nextCheck = check.next_check_at ? 
                new Date(check.next_check_at).toLocaleString('uk-UA') : 
                '–ù–µ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ';
            
            let notificationText = '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–µ—Ä—à–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏';
            if (check.last_result === 'error' && check.last_error_message) {
                notificationText = `–ü–æ–º–∏–ª–∫–∞: ${check.last_error_message}`;
            } else if (check.current_content) {
                const contentPreview = check.current_content.substring(0, 100);
                notificationText = `–ö–æ–Ω—Ç–µ–Ω—Ç: ${contentPreview}${check.current_content.length > 100 ? '...' : ''}`;
            }
            
            li.innerHTML = `
                <a href="/check/${check.id}" class="monitor-item">
                    <div class="monitor-header">
                        <span class="monitor-name">${check.name || 'Unnamed Check'}</span>
                        <span class="monitor-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="monitor-details">
                        <p><strong>URL:</strong> ${check.url}</p>
                        <p><strong>–°–µ–ª–µ–∫—Ç–æ—Ä:</strong> ${check.selector || '–í—Å—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞'}</p>
                        <p><strong>–Ü–Ω—Ç–µ—Ä–≤–∞–ª:</strong> ${check.interval} —Ö–≤–∏–ª–∏–Ω</p>
                        <p><strong>–û—Å—Ç–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞:</strong> ${lastChecked}</p>
                        <p><strong>–ù–∞—Å—Ç—É–ø–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞:</strong> ${nextCheck}</p>
                        <p><strong>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:</strong> ${notificationText}</p>
                    </div>
                </a>
            `;
            
            return li;
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–ø—É—Å–∫—É –∂–∏–≤–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω—å
        function startLiveUpdates() {
            if (liveUpdateInterval) return; // –£–∂–µ –∑–∞–ø—É—â–µ–Ω–æ
            
            liveUpdateInterval = setInterval(() => {
                if (!appSleeping) {
                    loadChecks();
                }
            }, 10000); // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
            
            console.log('üî¥ Live updates started');
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑—É–ø–∏–Ω–∫–∏ –∂–∏–≤–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω—å
        function stopLiveUpdates() {
            if (liveUpdateInterval) {
                clearInterval(liveUpdateInterval);
                liveUpdateInterval = null;
                console.log('‚è∏Ô∏è Live updates stopped');
            }
        }

        // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É —Å–Ω—É
        document.getElementById('sleepToggleBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = appSleeping ? '‚è≥ –í–∏–≤–æ–¥–∏–º–æ –∑ —Å–Ω—É...' : '‚è≥ –ó–∞—Å–∏–Ω–∞—î–º–æ...';
            
            try {
                const response = await fetch('/api/app-sleep-toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    appSleeping = result.new_state === 'sleeping';
                    updateSleepButton();
                    
                    if (result.action === 'wake_up') {
                        showMessage('‚úÖ –ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –≤–∏–≤–µ–¥–µ–Ω–æ –∑ —Ä–µ–∂–∏–º—É —Å–Ω—É. –í—Å—ñ –∞–∫—Ç–∏–≤–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.', 'success');
                        startLiveUpdates(); // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∂–∏–≤—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
                    } else {
                        showMessage('üí§ –ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ —Ä–µ–∂–∏–º —Å–Ω—É. –í—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ.', 'info');
                        stopLiveUpdates(); // –ó—É–ø–∏–Ω—è—î–º–æ –∂–∏–≤—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
                    }
                    
                    setTimeout(() => {
                        loadAppStatus();
                        loadChecks();
                    }, 1000);
                } else {
                    showMessage(`‚ùå ${result.error || '–ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ —Ä–µ–∂–∏–º—É'}`, 'error');
                }
                
            } catch (error) {
                console.error('Sleep toggle error:', error);
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // –ö–Ω–æ–ø–∫–∞ "–û–Ω–æ–≤–∏—Ç–∏"
        document.getElementById('refreshBtn').addEventListener('click', function() {
            console.log('üîÑ Manual refresh triggered');
            loadChecks();
            showMessage('üîÑ –°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–æ', 'info');
        });

        // –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ"
        document.getElementById('forceCheckAllBtn').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = '‚è≥ –í–∏–∫–æ–Ω—É—î–º–æ...';
            
            try {
                const response = await fetch('/api/force-check-all', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(`‚úÖ ${result.message}`, 'success');
                    setTimeout(() => loadChecks(), 2000);
                } else {
                    showMessage(`‚ùå ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö° –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ';
            }
        });

        // –§—É–Ω–∫—Ü—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI
        function updateSleepButton() {
            const btn = document.getElementById('sleepToggleBtn');
            if (appSleeping) {
                btn.textContent = '‚òÄÔ∏è –ü—Ä–æ–∫–∏–Ω—É—Ç–∏—Å—è';
                btn.className = 'btn btn-wake';
            } else {
                btn.textContent = 'üí§ –†–µ–∂–∏–º —Å–Ω—É';
                btn.className = 'btn btn-sleep';
            }
        }

        function updateSleepStatusDisplay(status) {
            const banner = document.getElementById('sleepStatusBanner');
            if (status.show_status_banner) {
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }

        async function loadAppStatus() {
            try {
                const response = await fetch('/api/app-status');
                if (response.ok) {
                    const status = await response.json();
                    appSleeping = status.is_sleeping;
                    updateSleepButton();
                    updateSleepStatusDisplay(status);
                    
                    // –ö–µ—Ä—É—î–º–æ –∂–∏–≤–∏–º–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º–∏
                    if (appSleeping) {
                        stopLiveUpdates();
                    } else if (!isInitialLoad) {
                        startLiveUpdates();
                    }
                }
            } catch (error) {
                console.error('Error loading app status:', error);
            }
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded, starting initialization...');
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–∞—Ç—É—Å –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É
            loadAppStatus();
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
            loadChecks();
            
            // –ü–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ –ø–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            setTimeout(() => {
                isInitialLoad = false;
                if (!appSleeping) {
                    startLiveUpdates();
                }
            }, 2000);
        });

        // –û—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('beforeunload', function() {
            stopLiveUpdates();
            if (startupCheckInterval) {
                clearInterval(startupCheckInterval);
            }
        });
    </script>
</body>
</html>