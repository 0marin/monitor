<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–µ–±-—Å–∞–π—Ç—ñ–≤ - Web Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Fallback styles if CSS doesn't load */
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f8f9fa; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≤–µ–±-—Å–∞–π—Ç—ñ–≤</h1>
            <div class="actions">
                <a href="/add" class="btn btn-add">‚ûï –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É</a>
                <button id="forceCheckAllBtn" class="btn btn-force">‚ö° –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤—Å—ñ</button>
                <button id="sleepToggleBtn" class="btn btn-sleep">üò¥ –†–µ–∂–∏–º —Å–Ω—É</button>
                <button id="diagnosticsBtn" class="btn btn-diagnostics">üîß –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
            </div>
        </header>

        <main>
            <div id="messageContainer"></div>
            
            <div id="appStatusContainer" style="display: none; margin-bottom: 15px;">
                <div id="sleepStatus" class="sleep-status">
                    <span id="sleepStatusText">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É...</span>
                </div>
            </div>
            
            <div id="loadingContainer" class="loading">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫...
            </div>

            <div id="checksContainer" style="display: none;">
                <h2>–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫</h2>
                <ul id="monitorList" class="monitor-list"></ul>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>üìã –ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</h3>
                <p>–î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É, —â–æ–± –ø–æ—á–∞—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥!</p>
                <a href="/add" class="btn btn-add">‚ûï –î–æ–¥–∞—Ç–∏ –ø–µ—Ä—à—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É</a>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
    <div id="diagnosticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üîß –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞</h3>
                <span id="closeDiagnostics" class="close">&times;</span>
            </div>
            <div id="diagnosticsContent">
                <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...</div>
            </div>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è CSS
        window.addEventListener('load', function() {
            const testElement = document.createElement('div');
            testElement.className = 'btn';
            document.body.appendChild(testElement);
            const styles = window.getComputedStyle(testElement);
            
            if (styles.padding === '0px' || styles.borderRadius === '0px') {
                console.warn('CSS –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
                // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ —Å—Ç–∏–ª—ñ –∞–±–æ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            }
            
            document.body.removeChild(testElement);
        });

        let allChecks = [];
        let appSleeping = false;

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            loadAppStatus();
            loadChecks();
        });

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
        async function loadChecks() {
            try {
                const response = await fetch('/api/checks');
                const checks = await response.json();
                
                allChecks = checks;
                displayChecks(checks);
                
                document.getElementById('loadingContainer').style.display = 'none';
                
                if (checks.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('checksContainer').style.display = 'block';
                }
                
            } catch (error) {
                showMessage('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫: ' + error.message, 'error');
                document.getElementById('loadingContainer').style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
        function displayChecks(checks) {
            const monitorList = document.getElementById('monitorList');
            monitorList.innerHTML = '';

            checks.forEach(check => {
                const listItem = document.createElement('li');
                
                const statusClass = getStatusClass(check);
                const statusText = getStatusText(check);
                
                listItem.innerHTML = `
                    <a href="/check/${check.id}" class="monitor-item">
                        <div class="monitor-header">
                            <span class="monitor-name">${escapeHtml(check.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏')}</span>
                            <span class="monitor-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="monitor-details">
                            <p class="monitor-url">üîó ${escapeHtml(check.url)}</p>
                            <p>üïê –û—Å—Ç–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: ${formatDateTime(check.last_checked_at)}</p>
                            <p>‚è∞ –ù–∞—Å—Ç—É–ø–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: ${formatDateTime(check.next_check_at)}</p>
                            <p>üîç –°–µ–ª–µ–∫—Ç–æ—Ä: ${escapeHtml(check.selector || '–í—Å—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞')}</p>
                            <p>‚è±Ô∏è –Ü–Ω—Ç–µ—Ä–≤–∞–ª: ${check.interval} —Ö–≤.</p>
                            ${check.last_error_message ? `<p style="color: #dc3545;">‚ùå –ü–æ–º–∏–ª–∫–∞: ${escapeHtml(check.last_error_message)}</p>` : ''}
                        </div>
                    </a>
                `;
                
                monitorList.appendChild(listItem);
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –ø—Ä–∏–º—É—Å–æ–≤–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—Å—ñ—Ö
        document.getElementById('forceCheckAllBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = '‚è≥ –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è...';
            
            try {
                const response = await fetch('/api/force-check-all', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(`‚úÖ ${result.message}`, 'success');
                    
                    // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
                    setTimeout(() => {
                        loadChecks();
                    }, 2000);
                } else {
                    showMessage(`‚ùå ${result.error}`, 'error');
                }
                
            } catch (error) {
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // –§—É–Ω–∫—Ü—ñ—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        document.getElementById('diagnosticsBtn').addEventListener('click', async function() {
            const modal = document.getElementById('diagnosticsModal');
            const content = document.getElementById('diagnosticsContent');
            
            modal.style.display = 'block';
            content.innerHTML = '<div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...</div>';
            
            try {
                const response = await fetch('/api/scheduler-diagnostics');
                const diagnostics = await response.json();
                
                if (response.ok) {
                    content.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <h4>üìä –°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞: <span style="color: ${diagnostics.status === 'running' ? '#28a745' : '#dc3545'}">${diagnostics.status === 'running' ? '–ü—Ä–∞—Ü—é—î' : '–ó—É–ø–∏–Ω–µ–Ω–æ'}</span></h4>
                            <p><strong>–ü–æ—Ç–æ—á–Ω–∏–π —á–∞—Å (UTC):</strong> ${diagnostics.current_time_utc}</p>
                            <p><strong>–ü–æ—Ç–æ—á–Ω–∏–π —á–∞—Å (–ª–æ–∫–∞–ª—å–Ω–∏–π):</strong> ${diagnostics.current_time_local}</p>
                            <p><strong>–ê–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å:</strong> ${diagnostics.jobs_count}</p>
                        </div>
                        
                        ${diagnostics.jobs_count > 0 ? `
                        <div>
                            <h4>üìã –ê–∫—Ç–∏–≤–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è:</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${diagnostics.jobs.map(job => `
                                    <div style="background-color: #f8f9fa; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 4px solid ${job.is_overdue ? '#dc3545' : '#28a745'};">
                                        <strong>${escapeHtml(job.name || job.id)}</strong><br>
                                        <small>ID: ${job.id}</small><br>
                                        <small>–ù–∞—Å—Ç—É–ø–Ω–∏–π –∑–∞–ø—É—Å–∫: ${job.next_run_local || '–ù–µ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ'}</small><br>
                                        <small>–¢—Ä–∏–≥–µ—Ä: ${job.trigger}</small>
                                        ${job.is_overdue ? '<br><span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ!</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : '<p>–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å.</p>'}
                    `;
                } else {
                    content.innerHTML = `<div style="color: #dc3545;">‚ùå –ü–æ–º–∏–ª–∫–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${diagnostics.error}</div>`;
                }
                
            } catch (error) {
                content.innerHTML = `<div style="color: #dc3545;">‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${error.message}</div>`;
            }
        });

        // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        document.getElementById('closeDiagnostics').addEventListener('click', function() {
            document.getElementById('diagnosticsModal').style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('diagnosticsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–æ–≥—Ä–∞–º–∏
        async function loadAppStatus() {
            try {
                const response = await fetch('/api/app-status');
                const status = await response.json();
                
                appSleeping = status.is_sleeping;
                updateSleepButton();
                updateSleepStatusDisplay(status);
                
            } catch (error) {
                console.error('Error loading app status:', error);
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º—É —Å–Ω—É
        function updateSleepButton() {
            const btn = document.getElementById('sleepToggleBtn');
            if (appSleeping) {
                btn.textContent = 'üåÖ –í–∏–≤–µ—Å—Ç–∏ –∑ —Å–Ω—É';
                btn.className = 'btn btn-wake';
                btn.title = '–í–∏–≤–µ—Å—Ç–∏ –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –∑ —Ä–µ–∂–∏–º—É —Å–Ω—É —Ç–∞ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏';
            } else {
                btn.textContent = 'üò¥ –†–µ–∂–∏–º —Å–Ω—É';
                btn.className = 'btn btn-sleep';
                btn.title = '–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –≤ —Ä–µ–∂–∏–º —Å–Ω—É (–ø—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏ –≤—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏)';
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É —Å–Ω—É
        function updateSleepStatusDisplay(status) {
            const container = document.getElementById('appStatusContainer');
            const statusText = document.getElementById('sleepStatusText');
            
            if (status.is_sleeping) {
                container.style.display = 'block';
                statusText.innerHTML = `
                    <strong>üò¥ –†–µ–∂–∏–º —Å–Ω—É –∞–∫—Ç–∏–≤–Ω–∏–π</strong> - 
                    –í—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ (${status.active_checks || 0} –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ —á–µ–∫–∞—é—Ç—å –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è)
                `;
                container.className = 'sleep-status sleeping';
            } else {
                if ((status.active_checks || 0) > 0) {
                    container.style.display = 'block';
                    statusText.innerHTML = `
                        <strong>üü¢ –ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –∞–∫—Ç–∏–≤–Ω–∏–π</strong> - 
                        –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è ${status.active_jobs_count || 0} –∑–∞–≤–¥–∞–Ω—å –∑ ${status.active_checks || 0} –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
                    `;
                    container.className = 'sleep-status active';
                } else {
                    container.style.display = 'none';
                }
            }
        }

        // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É —Å–Ω—É
        document.getElementById('sleepToggleBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = appSleeping ? '‚è≥ –í–∏–≤–æ–¥–∏–º–æ –∑ —Å–Ω—É...' : '‚è≥ –ó–∞—Å–∏–Ω–∞—î–º–æ...';
            
            try {
                const response = await fetch('/api/app-sleep-toggle', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    appSleeping = result.new_state === 'sleeping';
                    updateSleepButton();
                    showMessage(`‚úÖ ${result.message}`, 'success');
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å —Ç–∞ —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫
                    setTimeout(() => {
                        loadAppStatus();
                        loadChecks();
                    }, 1000);
                } else {
                    showMessage(`‚ùå ${result.error || '–ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ —Ä–µ–∂–∏–º—É'}`, 'error');
                }
                
            } catch (error) {
                showMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                if (!btn.textContent.includes('‚è≥')) {
                    btn.textContent = originalText;
                }
            }
        });

        // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        function getStatusClass(check) {
            if (check.status === 'paused') return 'status-paused';
            if (check.last_result === 'error') return 'status-error';
            if (check.last_result === 'changed') return 'status-changed';
            if (check.last_result === 'no_change') return 'status-no-change';
            return 'status-active';
        }

        function getStatusText(check) {
            if (check.status === 'paused') return '‚è∏Ô∏è –ü—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–æ';
            if (check.last_result === 'error') return '‚ùå –ü–æ–º–∏–ª–∫–∞';
            if (check.last_result === 'changed') return 'üîÑ –ó–º—ñ–Ω–∏';
            if (check.last_result === 'no_change') return '‚úÖ –ë–µ–∑ –∑–º—ñ–Ω';
            return 'üü¢ –ê–∫—Ç–∏–≤–Ω–∞';
        }

        function formatDateTime(isoString) {
            if (!isoString) return '–ù—ñ–∫–æ–ª–∏';
            
            try {
                const date = new Date(isoString);
                return date.toLocaleString('uk-UA', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '–ù–µ–≤—ñ–¥–æ–º–æ';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>